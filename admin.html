<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Manage Users</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    input[type=text] { width: 100%; padding: 6px; }
    button { padding: 6px 12px; cursor: pointer; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>

<h1>Admin Panel - Manage Users</h1>
<table>
  <thead>
    <tr>
      <th>Email</th>
      <th>Role</th>
      <th>Change Role</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="usersTableBody">
    <!-- Users will be loaded here -->
  </tbody>
</table>

<div id="message"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAPF4nGlb9R2osmXUwrPgatwAl1huIAGpg",
    authDomain: "admin-and-user-f50c3.firebaseapp.com",
    projectId: "admin-and-user-f50c3",
    storageBucket: "admin-and-user-f50c3.firebasestorage.app",
    messagingSenderId: "926355768153",
    appId: "1:926355768153:web:d52c55b2daf0e85a6e8248",
    measurementId: "G-7FES0VM8S1"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const usersTableBody = document.getElementById("usersTableBody");
  const messageDiv = document.getElementById("message");

  // Check if logged-in user is admin
  onAuthStateChanged(auth, async user => {
    if (!user) {
      alert("Please login first.");
      window.location.href = "index.html";
      return;
    }

    // Verify admin role
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists() || userDoc.data().role !== "admin") {
      alert("Access denied. Admins only.");
      window.location.href = "index.html";
      return;
    }

    loadUsers();
  });

  async function loadUsers() {
    usersTableBody.innerHTML = "";
    messageDiv.textContent = "";

    try {
      const querySnapshot = await getDocs(collection(db, "users"));

      querySnapshot.forEach(docSnap => {
        const userData = docSnap.data();

        const tr = document.createElement("tr");

        // Email cell
        const emailTd = document.createElement("td");
        emailTd.textContent = userData.email || "-";
        tr.appendChild(emailTd);

        // Current role cell
        const roleTd = document.createElement("td");
        roleTd.textContent = userData.role || "user";
        tr.appendChild(roleTd);

        // Change role input/select
        const changeRoleTd = document.createElement("td");
        const select = document.createElement("select");
        select.innerHTML = `
          <option value="user" ${userData.role === "user" ? "selected" : ""}>User</option>
          <option value="admin" ${userData.role === "admin" ? "selected" : ""}>Admin</option>
        `;
        changeRoleTd.appendChild(select);
        tr.appendChild(changeRoleTd);

        // Update button cell
        const actionTd = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "Update";
        btn.onclick = async () => {
          try {
            await updateDoc(doc(db, "users", docSnap.id), {
              role: select.value
            });
            messageDiv.textContent = `Role updated for ${userData.email}`;
            messageDiv.className = "success";
            roleTd.textContent = select.value;
          } catch (e) {
            messageDiv.textContent = "Error updating role: " + e.message;
            messageDiv.className = "error";
          }
        };
        actionTd.appendChild(btn);
        tr.appendChild(actionTd);

        usersTableBody.appendChild(tr);
      });
    } catch (e) {
      messageDiv.textContent = "Error loading users: " + e.message;
      messageDiv.className = "error";
    }
  }
</script>
</body>
</html>
