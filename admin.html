<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    select, button { padding: 5px; }
    #msg { margin-top: 10px; }
  </style>
</head>
<body>

<h1>Admin Panel - User Management</h1>

<table>
  <thead>
    <tr><th>Email</th><th>Role</th><th>Change Role</th><th>Action</th></tr>
  </thead>
  <tbody id="usersBody"></tbody>
</table>

<div id="msg"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAPF4nGlb9R2osmXUwrPgatwAl1huIAGpg",
    authDomain: "admin-and-user-f50c3.firebaseapp.com",
    projectId: "admin-and-user-f50c3",
    storageBucket: "admin-and-user-f50c3.firebasestorage.app",
    messagingSenderId: "926355768153",
    appId: "1:926355768153:web:d52c55b2daf0e85a6e8248",
    measurementId: "G-7FES0VM8S1"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const usersBody = document.getElementById('usersBody');
  const msg = document.getElementById('msg');

  // Check if user is admin, else redirect
  onAuthStateChanged(auth, async user => {
    if (!user) {
      alert('Please login first.');
      window.location.href = 'index.html';
      return;
    }

    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists() || userDoc.data().role !== "admin") {
      alert('Access denied. Admins only.');
      window.location.href = 'index.html';
      return;
    }

    loadUsers();
  });

  async function loadUsers() {
    usersBody.innerHTML = "";
    msg.textContent = "";

    try {
      const querySnapshot = await getDocs(collection(db, "users"));

      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();

        const tr = document.createElement('tr');

        // Email cell
        const tdEmail = document.createElement('td');
        tdEmail.textContent = data.email || "-";
        tr.appendChild(tdEmail);

        // Current role cell
        const tdRole = document.createElement('td');
        tdRole.textContent = data.role || "user";
        tr.appendChild(tdRole);

        // Role select dropdown
        const tdSelect = document.createElement('td');
        const select = document.createElement('select');
        select.innerHTML = `
          <option value="user" ${data.role === "user" ? "selected" : ""}>User</option>
          <option value="admin" ${data.role === "admin" ? "selected" : ""}>Admin</option>
        `;
        tdSelect.appendChild(select);
        tr.appendChild(tdSelect);

        // Update button
        const tdAction = document.createElement('td');
        const btn = document.createElement('button');
        btn.textContent = "Update";
        btn.onclick = async () => {
          try {
            await updateDoc(doc(db, "users", docSnap.id), { role: select.value });
            tdRole.textContent = select.value;
            msg.textContent = `Role updated for ${data.email}`;
            msg.style.color = "green";
          } catch (error) {
            msg.textContent = "Error updating role: " + error.message;
            msg.style.color = "red";
          }
        };
        tdAction.appendChild(btn);
        tr.appendChild(tdAction);

        usersBody.appendChild(tr);
      });

    } catch (error) {
      msg.textContent = "Error loading users: " + error.message;
      msg.style.color = "red";
    }
  }
</script>

</body>
</html>
